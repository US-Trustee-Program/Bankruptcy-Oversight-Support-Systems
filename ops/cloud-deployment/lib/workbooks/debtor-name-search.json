{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Search Dashboard\nMonitor frontend search behavior: filter usage, search volume, and user interaction patterns."
      },
      "name": "header"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "TimeRange",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 3600000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 432000000
                },
                {
                  "durationMs": 604800000
                }
              ]
            },
            "name": "TimeRange",
            "label": "Time Range"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "parameters"
    },
    {
      "type": 1,
      "content": {
        "json": "## Search Volume Over Time"
      },
      "name": "search-volume-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "customEvents \n| where name == \"search\" \n| where operation_Name == \"/search\" \n| where timestamp {TimeRange}\n| extend offset = todouble(customMeasurements.offset)\n| sort by session_Id asc, timestamp asc \n| extend SecondsSinceLastAction = datetime_diff('second', timestamp, prev(timestamp)) \n| extend IsNewNameSearch = iif(offset == 0 and (prev(session_Id) != session_Id or SecondsSinceLastAction > 5), 1, 0) \n| extend SearchGroupId = row_cumsum(IsNewNameSearch)\n// Group by the sequence first, then count the sequences per hour\n| summarize SequenceStartTime = min(timestamp) by session_Id, SearchGroupId\n| summarize SearchCount = count() by bin(SequenceStartTime, 1h)\n| order by SequenceStartTime asc",
        "size": 0,
        "title": "Searches Per Hour",
        "timeContextFromParameter": "TimeRange",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "barchart"
      },
      "name": "searches-per-hour"
    },
    {
      "type": 1,
      "content": {
        "json": "## Filter Usage Analysis"
      },
      "name": "filter-usage-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "customEvents \n| where name == 'search' \n| where operation_Name == \"/search\" \n| where timestamp {TimeRange} \n| extend d = customDimensions \n| extend offset = todouble(customMeasurements.offset)\n| sort by session_Id asc, timestamp asc \n| extend SecondsSinceLastAction = datetime_diff('second', timestamp, prev(timestamp)) \n| extend IsNewNameSearch = iif(offset == 0 and (prev(session_Id) != session_Id or SecondsSinceLastAction > 5), 1, 0) \n| extend SearchGroupId = row_cumsum(IsNewNameSearch)\n// Collapse the multi-page results into a single row per search sequence\n| summarize \n    DebtorNameUsed = max(tobool(d.debtorNameUsed) == true or tostring(d.debtorNameUsed) =~ 'true'),\n    CaseNumberUsed = max(isnotempty(tostring(d.caseNumber))),\n    ChaptersUsed = max(isnotempty(tostring(d.chapters)) and tostring(d.chapters) != '[]'),\n    DivisionUsed = max(isnotempty(tostring(d.divisionCodes)) and tostring(d.divisionCodes) != '[]'),\n    ExcludeClosedUsed = max(tobool(d.excludeClosedCases) == true or tostring(d.excludeClosedCases) =~ 'true')\n    by session_Id, SearchGroupId\n// Final count of unique search sequences where these filters were active\n| summarize \n    DebtorName = countif(DebtorNameUsed),\n    CaseNumber = countif(CaseNumberUsed),\n    Chapters = countif(ChaptersUsed),\n    DivisionCodes = countif(DivisionUsed),\n    ExcludeClosedCases = countif(ExcludeClosedUsed)\n| project DebtorName, CaseNumber, Chapters, DivisionCodes, ExcludeClosedCases",
        "size": 0,
        "title": "Filter Usage Counts",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "unstackedbar",
        "chartSettings": {
          "xAxis": "DebtorName"
        }
      },
      "name": "filter-usage-counts"
    },
    {
      "type": 1,
      "content": {
        "json": "## Search Details"
      },
      "name": "search-details-header"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "customEvents \n| where name == 'search' \n| where operation_Name == \"/search\" \n| where timestamp {TimeRange} \n| extend d = customDimensions \n| extend offset = todouble(customMeasurements.offset)\n| sort by session_Id asc, timestamp asc \n| extend SecondsSinceLastAction = datetime_diff('second', timestamp, prev(timestamp)) \n| extend IsNewNameSearch = iif(offset == 0 and (prev(session_Id) != session_Id or SecondsSinceLastAction > 5), 1, 0) \n| extend SearchGroupId = row_cumsum(IsNewNameSearch)\n| summarize \n    timestamp = min(timestamp), // This restores your timestamp column\n    HasDebtorName = iif(max(tobool(d.debtorNameUsed) == true or tostring(d.debtorNameUsed) =~ 'true'), 'Yes', 'No'), \n    HasCaseNumber = iif(max(isnotempty(tostring(d.caseNumber))), 'Yes', 'No'), \n    Chapters = any(tostring(d.chapters)), \n    ExcludeClosed = any(tostring(d.excludeClosedCases))\n    by session_Id, SearchGroupId\n| order by timestamp desc \n| project timestamp, HasDebtorName, HasCaseNumber, Chapters, ExcludeClosed\n| take 100",
        "size": 0,
        "title": "Recent Searches",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "grid"
      },
      "name": "recent-searches"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Debtor Name Search"
            },
            "name": "text - 4"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "customEvents \n| where name == \"search\" \n| where operation_Name == \"/search\" \n| where timestamp {TimeRange}\n| extend d = customDimensions \n| extend offset = todouble(customMeasurements.offset)\n| sort by session_Id asc, timestamp asc \n| extend SecondsSinceLastAction = datetime_diff('second', timestamp, prev(timestamp)) \n| extend IsNewNameSearch = iif(offset == 0 and (prev(session_Id) != session_Id or SecondsSinceLastAction > 5), 1, 0) \n| extend SearchGroupId = row_cumsum(IsNewNameSearch)\n| summarize \n    // This logic ensures we catch 'true' as a string or a boolean\n    WasDebtorSearch = max(tostring(d.debtorNameUsed) =~ \"true\" or tobool(d.debtorNameUsed) == true)\n    by session_Id, SearchGroupId\n| extend Intent = iif(WasDebtorSearch == true, \"Debtor Name Used\", \"Other Filter Used\")\n| summarize TotalSearches = count() by Intent",
              "size": 3,
              "title": "Debtor Name Field Usage",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.insights/components",
              "visualization": "piechart"
            },
            "customWidth": "50",
            "name": "percent-with-debtor-name",
            "styleSettings": {
              "maxWidth": "50"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let details = pageViews | where name contains \"Case Detail\" | project ViewTime = timestamp, session_Id;\ncustomEvents\n| where name == \"search\"\n| where operation_Name == \"/search\"\n| extend offset = todouble(customMeasurements.offset)\n| sort by session_Id asc, timestamp asc\n| extend SecondsSinceLastAction = datetime_diff('second', timestamp, prev(timestamp))\n| extend IsNewNameSearch = iif(offset == 0 and (prev(session_Id) != session_Id or SecondsSinceLastAction > 5), 1, 0)\n| extend SearchGroupId = row_cumsum(IsNewNameSearch)\n| extend NextSearchStart = next(timestamp)\n| join kind=leftouter details on session_Id\n| extend isSuccess = iif(ViewTime > timestamp and (isempty(NextSearchStart) or ViewTime < NextSearchStart), 1, 0)\n| summarize \n    MaxPageReached = max(round((offset / 50) + 1, 0)),\n    SearchSuccess = max(isSuccess)\n    by session_Id, SearchGroupId\n| summarize \n    TotalUserSearches = count(),\n    SuccessfulSearches = sum(SearchSuccess),\n    AvgPageDepth = round(avg(MaxPageReached), 2)\n| where TotalUserSearches > 0\n| extend ClickThroughRate = round(toreal(SuccessfulSearches) / TotalUserSearches * 100, 2)\n| project ClickThroughRate, AvgPageDepth, TotalUserSearches",
              "size": 3,
              "title": "Debtor Name Search CTR and Pagination Depth",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.insights/components",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {},
                "leftContent": {
                  "columnMatch": "ClickThroughRate",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "colors",
                    "thresholdsGrid": [
                      {
                        "operator": ">",
                        "thresholdValue": "80",
                        "representation": "green",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": ">",
                        "thresholdValue": "50",
                        "representation": "yellow",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "<",
                        "thresholdValue": "50",
                        "representation": "redBright",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "lightBlue",
                        "text": "{0}{1}"
                      }
                    ]
                  }
                },
                "rightContent": {
                  "columnMatch": "AvgPageDepth",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "colors",
                    "thresholdsGrid": [
                      {
                        "operator": "<",
                        "thresholdValue": "3",
                        "representation": "green",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": ">=",
                        "thresholdValue": "3",
                        "representation": "redBright",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "lightBlue",
                        "text": "{0}{1}"
                      }
                    ]
                  }
                },
                "showBorder": true,
                "size": "auto"
              }
            },
            "customWidth": "0",
            "name": "ctr-pagination-visual",
            "styleSettings": {
              "maxWidth": "50"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let details = pageViews | where name contains \"Case Detail\" | project ViewTime = timestamp, session_Id;\ncustomEvents\n| where name == \"search\"\n| where operation_Name == \"/search\"\n| extend offset = todouble(customMeasurements.offset)\n| sort by session_Id asc, timestamp asc\n| extend SecondsSinceLastAction = datetime_diff('second', timestamp, prev(timestamp))\n| extend IsNewNameSearch = iif(offset == 0 and (prev(session_Id) != session_Id or SecondsSinceLastAction > 5), 1, 0)\n| extend SearchGroupId = row_cumsum(IsNewNameSearch)\n| summarize \n    MaxPageInSession = max(round((offset / 50) + 1, 0)),\n    Intent = \"Debtor Name Used\" // We know these are manual searches\n    by session_Id, SearchGroupId\n| summarize \n    AvgPageReached = round(avg(MaxPageInSession), 2),\n    MaxPageReached = max(MaxPageInSession),\n    TotalEvents = count() // This will now show 3\n    by Intent",
              "size": 3,
              "title": "Pagination Depth",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.insights/components",
              "visualization": "table"
            },
            "name": "pagination-depth"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let details = pageViews \n    | where name contains \"Case Detail\" \n    | project ViewTime = timestamp, session_Id, \n              ViewedCaseID = extract(\"/case-detail/([^/?#]+)\", 1, url);\ncustomEvents \n| where name == \"search\" \n| where operation_Name == \"/search\" \n| extend d = customDimensions\n| where tostring(d.debtorNameUsed) =~ \"true\" or tobool(d.debtorNameUsed) == true\n| extend offset = todouble(customMeasurements.offset)\n| sort by session_Id asc, timestamp asc \n| extend SecondsSinceLastAction = datetime_diff('second', timestamp, prev(timestamp)) \n| extend IsNewNameSearch = iif(offset == 0 and (prev(session_Id) != session_Id or SecondsSinceLastAction > 5), 1, 0) \n| extend SearchGroupId = row_cumsum(IsNewNameSearch) \n| extend NextSearchStart = next(timestamp)\n| join kind=leftouter details on session_Id\n| extend isMatch = iif(ViewTime > timestamp and (isempty(NextSearchStart) or ViewTime < NextSearchStart), 1, 0)\n| summarize \n    SearchTime = min(timestamp),\n    CaseID = anyif(ViewedCaseID, isMatch == 1),\n    Outcome = iif(max(isMatch) == 1, \"✅ Success\", \"❌ Abandoned\")\n    by session_Id, SearchGroupId\n| extend AppLink = iif(isnotempty(CaseID), strcat(\"https://ustp-cams-webapp.azurewebsites.us/case-detail/\", CaseID, \"/\"), \"\")\n| project SearchTime, Outcome, CaseID, AppLink\n| order by SearchTime desc",
              "size": 0,
              "title": "Individual Session Deep Dive",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.insights/components",
              "visualization": "grid",
              "gridSettings": {
                "sortBy": [
                  {
                    "itemKey": "SearchTime",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "SearchTime",
                  "sortOrder": 2
                }
              ]
            },
            "name": "debtor-name-searches"
          }
        ]
      },
      "name": "debtor-name-analysis-group"
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/729f9083-9edf-4269-919f-3f05f7a0ab20/resourceGroups/rg-cams-app-dev-f64e59/providers/Microsoft.Insights/components/appi-ustp-cams-dev-f64e59-webapp"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
