name: End-to-end Tests

on:
  workflow_call:
    inputs:
      path:
        required: true
        type: string
      node-version:
        required: true
        type: string

jobs:
  pa11y-accessibility-test:
    defaults:
      run:
        working-directory: user-interface

    runs-on: ubuntu-latest

    steps:
      - name: Install chrome
        uses: browser-actions/setup-chrome@v1

      - name: Get source code
        uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ vars.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: user-interface/package-lock.json

      - name: Install Node dependencies
        run: |
          pushd ../common
          npm ci
          popd

          npm ci && npm install -g pa11y-ci

      - name: Run pa11y Test
        run: ../ops/scripts/pipeline/accessibility-test.sh
  playwright-accessibility-test:
    defaults:
      run:
        working-directory: ${{ inputs.path }}
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Install chrome
        uses: browser-actions/setup-chrome@v1
      - name: Get source code
        uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.path }}/package-lock.json

      - name: CI Common
        working-directory: common
        run: |
          npm ci

      - name: Install Node dependencies
        run: |
          npm ci
          npx playwright install chromium msedge

      - name: Run UI in mock mode
        run: |
          export CAMS_USE_FAKE_API=true
          export CAMS_LOGIN_PROVIDER=none
          npm run build
          npm install serve -g
          serve -s build &
          if ! timeout 120s sh -c 'until nc -z localhost 3000; do sleep 1; done'; then
              echo "Webapp check timed out"
              exit 1
          fi

      - name: Run Playwright a11y Tests
        id: playwrightA11yTests
        run: |
          npm run test:a11y

      - name: Upload report
        uses: actions/upload-artifact@v4.4.0
        if: always()
        with:
          name: playwright-a11y-report
          path: ${{ inputs.path }}/playwright-report/
          retention-days: 30
