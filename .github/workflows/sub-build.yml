name: Build

on:
  workflow_call:
    inputs:
      nodeVersion:
        required: true
        type: string
      apiFunctionName:
        required: true
        type: string
      dataflowsFunctionName:
        required: true
        type: string
      camsServerPort:
        required: true
        type: string
      camsServerProtocol:
        required: true
        type: string
      camsBasePath:
        required: true
        type: string
      webappName:
        required: true
        type: string
      environment:
        required: true
        type: string
      launchDarklyEnvironment:
        required: true
        type: string
      azResourceGrpAppEncrypted:
        required: true
        type: string
      slotName:
        required: true
        type: string
jobs:
  see-slot-name:
    runs-on: ubuntu-latest
    steps:
      - name: See Slot Name
        run: |
          echo "Slot name: ${{ inputs.slotName }}"

  build-frontend-predeployment:
    name: Build Frontend Predeployment
    uses: ./.github/workflows/reusable-build-frontend.yml
    secrets: inherit # pragma: allowlist secret
    with:
      nodeVersion: ${{ vars.NODE_VERSION }}
      camsServerHostname: ${{ inputs.apiFunctionName }}.azurewebsites.us
      camsStagingHostname: ${{ inputs.apiFunctionName }}-${{ inputs.slotName }}.azurewebsites.us
      camsServerPort: ${{ vars.CAMS_SERVER_PORT }}
      camsServerProtocol: ${{ vars.CAMS_SERVER_PROTOCOL }}
      camsBasePath: ${{ vars.CAMS_BASE_PATH }}
      webappName: ${{ inputs.webappName }}
      environment: ${{ inputs.environment }}
      launchDarklyEnvironment: ${{ vars.CAMS_LAUNCH_DARKLY_ENV }}
      azResourceGrpAppEncrypted: ${{ inputs.azResourceGrpAppEncrypted }}

  backend:
    defaults:
      run:
        working-directory: backend

    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

      - name: Execute Build
        run: |
          npm run build-common
          npm ci
          npm run build:api
          npm run build:dataflows

      - uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        if: vars.CAMS_LOGIN_PROVIDER == 'dev'
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ vars.AZURE_ENVIRONMENT }}

      - uses: cloudposse/github-action-secret-outputs@main
        if: vars.CAMS_LOGIN_PROVIDER == 'dev'
        id: rgApp
        with:
          secret: ${{ secrets.PGP_SIGNING_PASSPHRASE }}
          op: decode
          in: ${{ inputs.azResourceGrpAppEncrypted }}

      - name: Retrieve dev-users.json from Key Vault
        if: vars.CAMS_LOGIN_PROVIDER == 'dev'
        run: |
          # Retrieve the DEV_USERS secret from Key Vault
          DEV_USERS_JSON=$(az keyvault secret show --vault-name ${{ secrets.AZ_KV_APP_CONFIG_NAME }} --name DEV-USERS --query value -o tsv)

          # Write the JSON to dev-users.json file
          echo "$DEV_USERS_JSON" > dev-users.json
          echo "dev-users.json created successfully for deployment"

      - name: Package API
        run: OUT=${{ inputs.apiFunctionName }} npm run pack

      - name: Package Data Flow Artifact
        run: OUT=${{ inputs.dataflowsFunctionName }} npm run pack:dataflows

      - name: Upload API Azure Functions Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ inputs.apiFunctionName }}-build
          path: backend/function-apps/api/${{ inputs.apiFunctionName }}.zip
          if-no-files-found: error

      - name: Upload Data Flows Azure Functions Artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ inputs.dataflowsFunctionName }}-build
          path: backend/function-apps/dataflows/${{ inputs.dataflowsFunctionName }}.zip
          if-no-files-found: error
