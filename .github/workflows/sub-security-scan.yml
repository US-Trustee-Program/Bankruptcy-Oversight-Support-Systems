name: Security

on: workflow_call

jobs:
  sca-scan:
    name: SCA Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Snyk CLI
        uses: snyk/actions/setup@9adf32b1121593767fc3c057af55b55db032dc04 # v1
        with:
          snyk-version: latest

      - name: Authenticate with Snyk
        run: snyk auth --auth-type=oauth --client-secret="$SNYK_OAUTH_CLIENT_SECRET" --client-id="$SNYK_OAUTH_CLIENT_ID"
        env:
          SNYK_API: https://api.snykgov.io
          SNYK_OAUTH_CLIENT_SECRET: ${{ secrets.SNYK_OAUTH_CLIENT_SECRET }}
          SNYK_OAUTH_CLIENT_ID: ${{ secrets.SNYK_OAUTH_CLIENT_ID }}

      - name: Run Snyk SCA scan
        run: snyk test --all-projects --severity-threshold=medium --policy-path=. --sarif-file-output=snyk-sca.sarif
        env:
          SNYK_API: https://api.snykgov.io

      - name: Monitor project in Snyk
        if: always()
        run: snyk monitor --all-projects
        env:
          SNYK_API: https://api.snykgov.io

      - uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        if: always()
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ vars.AZURE_ENVIRONMENT }}

      - name: Upload raw SARIF to Azure Storage
        if: always()
        run: |
          if [ -f snyk-sca.sarif ]; then
            ACCOUNT_KEY=$(az storage account keys list \
              -n "$ACCOUNT_NAME" \
              -g "$RESOURCE_GROUP" \
              --query '[0].value' -o tsv)
            az storage blob upload \
              --account-name "$ACCOUNT_NAME" \
              --account-key "$ACCOUNT_KEY" \
              -f snyk-sca.sarif \
              -c security-scan-results \
              -n "snyk-sca-${{ github.run_number }}-${{ github.run_attempt }}-${{ github.ref_name }}.sarif" \
              --overwrite
          fi
        env:
          ACCOUNT_NAME: ${{ secrets.AZ_SECURITY_SCAN_STORAGE_NAME }}
          RESOURCE_GROUP: ${{ secrets.AZ_SECURITY_SCAN_RG }}

      - name: Sanitize SARIF for GitHub upload
        if: always()
        run: |
          if [ -f snyk-sca.sarif ]; then
            jq 'walk(
              if type == "object" and has("security-severity") and
                (.["security-severity"] | type == "string") and
                (.["security-severity"] | test("^[0-9]+(\\.[0-9]+)?$") | not)
              then del(.["security-severity"])
              else . end
            )' snyk-sca.sarif > snyk-sca-sanitized.sarif && mv snyk-sca-sanitized.sarif snyk-sca.sarif
          fi

      - name: Upload SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3
        with:
          sarif_file: snyk-sca.sarif

  sast-scan:
    name: SAST Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Snyk CLI
        uses: snyk/actions/setup@9adf32b1121593767fc3c057af55b55db032dc04 # v1
        with:
          snyk-version: latest

      - name: Authenticate with Snyk
        run: snyk auth --auth-type=oauth --client-secret="$SNYK_OAUTH_CLIENT_SECRET" --client-id="$SNYK_OAUTH_CLIENT_ID"
        env:
          SNYK_API: https://api.snykgov.io
          SNYK_OAUTH_CLIENT_SECRET: ${{ secrets.SNYK_OAUTH_CLIENT_SECRET }}
          SNYK_OAUTH_CLIENT_ID: ${{ secrets.SNYK_OAUTH_CLIENT_ID }}

      - name: Run Snyk Code (SAST) scan
        id: snyk-scan
        continue-on-error: true
        run: snyk code test --severity-threshold=medium --sarif-file-output=snyk-code.sarif
        env:
          SNYK_API: https://api.snykgov.io

      - uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        if: always()
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ vars.AZURE_ENVIRONMENT }}

      - name: Upload raw SARIF to Azure Storage
        if: always()
        run: |
          if [ -f snyk-code.sarif ]; then
            ACCOUNT_KEY=$(az storage account keys list \
              -n "$ACCOUNT_NAME" \
              -g "$RESOURCE_GROUP" \
              --query '[0].value' -o tsv)
            az storage blob upload \
              --account-name "$ACCOUNT_NAME" \
              --account-key "$ACCOUNT_KEY" \
              -f snyk-code.sarif \
              -c security-scan-results \
              -n "snyk-code-${{ github.run_number }}-${{ github.run_attempt }}-${{ github.ref_name }}.sarif" \
              --overwrite
          fi
        env:
          ACCOUNT_NAME: ${{ secrets.AZ_SECURITY_SCAN_STORAGE_NAME }}
          RESOURCE_GROUP: ${{ secrets.AZ_SECURITY_SCAN_RG }}

      - name: Download SAST baseline
        id: baseline
        if: always()
        run: |
          ACCOUNT_KEY=$(az storage account keys list \
            -n "$ACCOUNT_NAME" \
            -g "$RESOURCE_GROUP" \
            --query '[0].value' -o tsv)
          if az storage blob download \
            --account-name "$ACCOUNT_NAME" \
            --account-key "$ACCOUNT_KEY" \
            -c snyk-baseline \
            -n snyk-code-baseline.txt \
            -f snyk-code-baseline.txt 2>/dev/null; then
            echo "baseline_found=true" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::No SAST baseline found. All findings will be treated as new."
            echo "baseline_found=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          ACCOUNT_NAME: ${{ secrets.AZ_SECURITY_SCAN_STORAGE_NAME }}
          RESOURCE_GROUP: ${{ secrets.AZ_SECURITY_SCAN_RG }}

      - name: Compare against baseline
        id: baseline-compare
        if: ${{ always() && steps.snyk-scan.outcome == 'failure' }}
        run: |
          if ops/scripts/pipeline/snyk-baseline-compare.sh snyk-code.sarif snyk-code-baseline.txt; then
            echo "has_new_findings=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_new_findings=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Sanitize SARIF for GitHub upload
        if: always()
        run: |
          if [ -f snyk-code.sarif ]; then
            jq 'walk(
              if type == "object" and has("security-severity") and
                (.["security-severity"] | type == "string") and
                (.["security-severity"] | test("^[0-9]+(\\.[0-9]+)?$") | not)
              then del(.["security-severity"])
              else . end
            )' snyk-code.sarif > snyk-code-sanitized.sarif && mv snyk-code-sanitized.sarif snyk-code.sarif
          fi

      - name: Upload SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3
        with:
          sarif_file: snyk-code.sarif

      - name: Fail on new findings
        if: always()
        env:
          SCAN_OUTCOME: ${{ steps.snyk-scan.outcome }}
          HAS_NEW_FINDINGS: ${{ steps.baseline-compare.outputs.has_new_findings }}
        run: |
          if [[ "$SCAN_OUTCOME" == "success" ]]; then
            echo "Snyk Code scan passed â€” no findings."
            exit 0
          fi
          if [[ "$HAS_NEW_FINDINGS" == "true" ]]; then
            echo "New SAST findings detected that are not in the baseline."
            exit 1
          fi
          echo "Snyk Code scan found issues, but all match the accepted baseline."
          exit 0
