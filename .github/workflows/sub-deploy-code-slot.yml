name: Deploy code for slot

on:
  workflow_call:
    inputs:
      ghaEnvironment:
        required: true
        type: string
      environmentHash:
        required: true
        type: string
      stackName:
        required: true
        type: string
      webappName:
        required: true
        type: string
      apiFunctionName:
        required: true
        type: string
      migrationFunctionName:
        required: true
        type: string
      azResourceGrpAppEncrypted:
        required: true
        type: string
      slotName:
        required: true
        type: string
      e2eCosmosDbExists:
        required: true
        type: string
      initialDeployment:
        required: true
        type: string

jobs:
  build-frontend-deployment:
    name: Build Frontend deployment
    uses: ./.github/workflows/reusable-build-frontend.yml
    secrets: inherit # pragma: allowlist secret
    with:
      nodeVersion: ${{ vars.NODE_VERSION }}
      camsServerHostname: ${{ inputs.apiFunctionName }}.azurewebsites.us
      camsServerPort: ${{ vars.CAMS_SERVER_PORT }}
      camsServerProtocol: ${{ vars.CAMS_SERVER_PROTOCOL }}
      camsBasePath: ${{ vars.CAMS_BASE_PATH }}
      webappName: ${{ inputs.webappName }}
      environment: ${{ inputs.ghaEnvironment }}
      launchDarklyEnvironment: ${{ vars.CAMS_LAUNCH_DARKLY_ENV }}
      azResourceGrpAppEncrypted: ${{ inputs.azResourceGrpAppEncrypted }}
      isDeployment: true

  deploy-code:
    if: ${{ inputs.initialDeployment == 'true' }}
    needs: [build-frontend-deployment]
    name: Slot Code Deployment
    uses: ./.github/workflows/sub-deploy-code.yml
    with:
      ghaEnvironment: ${{ inputs.ghaEnvironment }}
      environmentHash: ${{ inputs.environmentHash }}
      stackName: ${{ inputs.stackName }}
      webappName: ${{ inputs.webappName }}
      apiFunctionName: ${{ inputs.apiFunctionName }}
      migrationFunctionName: ${{ inputs.migrationFunctionName }}
      azResourceGrpAppEncrypted: ${{ inputs.azResourceGrpAppEncrypted }}
    secrets: inherit # pragma: allowlist secret

  deploy-webapp-slot:
    needs: [build-frontend-deployment]
    runs-on: ubuntu-latest
    environment: ${{ inputs.ghaEnvironment }}
    steps:
      - uses: actions/checkout@main

      - name: Download artifact from build job
        uses: actions/download-artifact@v4.1.7
        with:
          name: ${{ inputs.webappName }}-build

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ vars.AZURE_ENVIRONMENT }}

      - uses: cloudposse/github-action-secret-outputs@main
        id: rgApp
        with:
          secret: ${{ secrets.PGP_SIGNING_PASSPHRASE }}
          op: decode
          in: ${{ inputs.azResourceGrpAppEncrypted }}

      - name: Deploy to Azure WebApp Slot
        id: deploy-webapp-slot-step
        run: |
          ./ops/scripts/pipeline/slots/az-app-slot-deploy.sh \
          --src ./${{ inputs.webappName }}.zip \
          -g ${{ steps.rgApp.outputs.out }} \
          -n ${{ inputs.webappName }} \
          --slotName ${{ inputs.slotName }}

  deploy-api-slot:
    runs-on: ubuntu-latest
    environment: ${{ inputs.ghaEnvironment }}
    steps:
      - uses: actions/checkout@main

      - name: Download artifact from build job
        uses: actions/download-artifact@v4.1.7
        with:
          name: ${{ inputs.apiFunctionName }}-build

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ vars.AZURE_ENVIRONMENT }}

      - uses: cloudposse/github-action-secret-outputs@main
        id: rgApp
        with:
          secret: ${{ secrets.PGP_SIGNING_PASSPHRASE }}
          op: decode
          in: ${{ inputs.azResourceGrpAppEncrypted }}

      - name: Deploy Azure Function API slot
        id: deploy-api-slot-step
        run: |
          ./ops/scripts/pipeline/slots/az-func-slot-deploy.sh \
          -g ${{ steps.rgApp.outputs.out }} \
          -n ${{ inputs.apiFunctionName }} \
          --src ./${{ inputs.apiFunctionName }}.zip \
          --slotName ${{ inputs.slotName }}

  deploy-migration-slot:
    runs-on: ubuntu-latest
    environment: ${{ inputs.ghaEnvironment }}
    steps:
      - uses: actions/checkout@main

      - name: Download artifact from build job
        uses: actions/download-artifact@v4.1.7
        with:
          name: ${{ inputs.migrationFunctionName }}-build

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ vars.AZURE_ENVIRONMENT }}

      - uses: cloudposse/github-action-secret-outputs@main
        id: rgApp
        with:
          secret: ${{ secrets.PGP_SIGNING_PASSPHRASE }}
          op: decode
          in: ${{ inputs.azResourceGrpAppEncrypted }}

      - name: Deploy Azure Function Migration slot
        id: deploy-migration-slot-step
        run: |
          az functionapp start -g ${{ steps.rgApp.outputs.out }} --name ${{ inputs.migrationFunctionName }} --slot ${{ inputs.slotName }}

          ./ops/scripts/pipeline/slots/az-func-slot-deploy.sh \
          -g ${{ steps.rgApp.outputs.out }} \
          -n ${{ inputs.migrationFunctionName }} \
          --src ./${{ inputs.migrationFunctionName }}.zip \
          --slotName ${{ inputs.slotName }}

  endpoint-test-application-slot:
    needs: [deploy-webapp-slot, deploy-api-slot, deploy-migration-slot]
    uses: ./.github/workflows/reusable-endpoint-test.yml
    with:
      stackName: ${{ inputs.stackName }}
      webappName: ${{ inputs.webappName }}
      apiFunctionName: ${{ inputs.apiFunctionName }}
      branchHashId: ${{ inputs.environmentHash }}
      ghaEnvironment: ${{ inputs.ghaEnvironment }}
      azResourceGrpAppEncrypted: ${{ inputs.azResourceGrpAppEncrypted }}
      slotName: ${{ inputs.slotName }}
    secrets: inherit # pragma: allowlist secret

  execute-e2e-test:
    needs:
      [
        deploy-webapp-slot,
        deploy-api-slot,
        deploy-migration-slot,
        endpoint-test-application-slot,
      ]
    uses: ./.github/workflows/reusable-e2e.yml
    with:
      apiFunctionName: ${{ inputs.apiFunctionName }}
      slotName: ${{ inputs.slotName }}
      webappName: ${{ inputs.webappName }}
      stackName: ${{ inputs.stackName }}
      azResourceGrpAppEncrypted: ${{ inputs.azResourceGrpAppEncrypted }}
      ghaEnvironment: ${{ inputs.ghaEnvironment }}
      branchHashId: ${{ inputs.environmentHash }}
      e2eCosmosDbExists: ${{ inputs.e2eCosmosDbExists }}
    secrets: inherit # pragma: allowlist secret

  swap-webapp-deployment-slot:
    if: ${{ inputs.initialDeployment != 'true' }}
    runs-on: ubuntu-latest
    needs:
      [
        deploy-webapp-slot,
        deploy-api-slot,
        deploy-migration-slot,
        execute-e2e-test,
      ]
    environment: ${{ inputs.ghaEnvironment }}
    env:
      webappName: ${{ inputs.webappName }}
      slotName: ${{ inputs.slotName }}
    steps:
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ vars.AZURE_ENVIRONMENT }}
      - uses: cloudposse/github-action-secret-outputs@main
        id: rgApp
        with:
          secret: ${{ secrets.PGP_SIGNING_PASSPHRASE }}
          op: decode
          in: ${{ inputs.azResourceGrpAppEncrypted }}
      - name: Swap Deployment Slot
        run: |
          az webapp deployment slot swap --slot ${{ env.slotName }} --name ${{ env.webappName }} -g ${{ steps.rgApp.outputs.out }}
          az webapp traffic-routing clear --name ${{ env.webappName }} -g ${{ steps.rgApp.outputs.out }}

  swap-nodeapi-deployment-slot:
    if: ${{ inputs.initialDeployment != 'true' }}
    runs-on: ubuntu-latest
    needs:
      [
        deploy-webapp-slot,
        deploy-api-slot,
        deploy-migration-slot,
        execute-e2e-test,
      ]
    environment: ${{ inputs.ghaEnvironment }}
    env:
      apiFunctionName: ${{ inputs.apiFunctionName }}
      slotName: ${{ inputs.slotName }}
    steps:
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ vars.AZURE_ENVIRONMENT }}
      - uses: cloudposse/github-action-secret-outputs@main
        id: rgApp
        with:
          secret: ${{ secrets.PGP_SIGNING_PASSPHRASE }}
          op: decode
          in: ${{ inputs.azResourceGrpAppEncrypted }}
      - name: Swap Deployment Slot
        run: |
          az functionapp deployment slot swap --slot ${{ env.slotName }} --name ${{ env.apiFunctionName }} -g ${{ steps.rgApp.outputs.out }}
          az webapp traffic-routing clear --name ${{ env.apiFunctionName }} -g ${{ steps.rgApp.outputs.out }}

  swap-migration-app-deployment-slot:
    if: ${{ inputs.initialDeployment != 'true' }}
    runs-on: ubuntu-latest
    needs:
      [
        deploy-webapp-slot,
        deploy-api-slot,
        deploy-migration-slot,
        execute-e2e-test,
      ]
    environment: ${{ inputs.ghaEnvironment }}
    env:
      slotName: ${{ inputs.slotName }}
    steps:
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ vars.AZURE_ENVIRONMENT }}
      - uses: cloudposse/github-action-secret-outputs@main
        id: rgApp
        with:
          secret: ${{ secrets.PGP_SIGNING_PASSPHRASE }}
          op: decode
          in: ${{ inputs.azResourceGrpAppEncrypted }}
      - name: Swap Deployment Slot
        run: |
          az functionapp deployment slot swap --slot ${{ env.slotName }} --name ${{ inputs.migrationFunctionName }} -g ${{ steps.rgApp.outputs.out }}
          az webapp traffic-routing clear --name ${{ inputs.migrationFunctionName }} -g ${{ steps.rgApp.outputs.out }}
          az functionapp stop -g ${{ steps.rgApp.outputs.out }} --name ${{ inputs.migrationFunctionName }} --slot ${{ inputs.slotName }}

  endpoint-test-application-post-swap:
    needs:
      [
        swap-nodeapi-deployment-slot,
        swap-webapp-deployment-slot,
        swap-migration-app-deployment-slot,
      ]
    uses: ./.github/workflows/reusable-endpoint-test.yml
    with:
      stackName: ${{ inputs.stackName }}
      webappName: ${{ inputs.webappName }}
      apiFunctionName: ${{ inputs.apiFunctionName }}
      branchHashId: ${{ inputs.environmentHash }}
      ghaEnvironment: ${{ inputs.ghaEnvironment }}
      azResourceGrpAppEncrypted: ${{ inputs.azResourceGrpAppEncrypted }}
      slotName: "self"
    secrets: inherit # pragma: allowlist secret

  enable-access:
    runs-on: ubuntu-latest
    needs: [endpoint-test-application-post-swap]
    environment: ${{ inputs.ghaEnvironment }}
    env:
      webappName: ${{ inputs.webappName }}
      apiFunctionName: ${{ inputs.apiFunctionName }}
    steps:
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: ${{ vars.AZURE_ENVIRONMENT }}

      - uses: cloudposse/github-action-secret-outputs@main
        id: rgApp
        with:
          secret: ${{ secrets.PGP_SIGNING_PASSPHRASE }}
          op: decode
          in: ${{ inputs.azResourceGrpAppEncrypted }}

      - name: Enable production slot access
        run: |
          az webapp config access-restriction add --resource-group ${{ steps.rgApp.outputs.out }} --name ${{ env.webappName }} --rule-name AllowAll --action Allow --ip-address 0.0.0.0/0 --priority 100 1>/dev/null || true
          az functionapp config access-restriction add --resource-group ${{ steps.rgApp.outputs.out }} --name ${{ env.apiFunctionName }} --rule-name AllowAll --action Allow --ip-address 0.0.0.0/0 --priority 100 1>/dev/null || true
          az functionapp config access-restriction add --resource-group ${{ steps.rgApp.outputs.out }} --name ${{ inputs.migrationFunctionName }} --rule-name AllowAll --action Allow --ip-address 0.0.0.0/0 --priority 100 1>/dev/null || true
