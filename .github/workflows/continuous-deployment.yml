name: Continuous Deployment

on: [push]


jobs:
  eslint:
    if: ${{ false }}  # disable for now
    name: Run eslint scanning
    defaults:
      run:
        working-directory: gui
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install ESLint
        run: |
          npm install eslint@8.10.0
          npm install @microsoft/eslint-formatter-sarif@2.1.7

      - name: Run ESLint
        run: npx eslint .
          --config .eslintrc.json
          --ext .js,.jsx,.ts,.tsx
          --format @microsoft/eslint-formatter-sarif
          --output-file eslint-results.sarif
        continue-on-error: true

      - name: Upload analysis results to GitHub
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gui/eslint-results.sarif
          wait-for-processing: true

  build:
    defaults:
      run:
        working-directory: gui

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: gui/package-lock.json

      - run: npm ci
      - run: npm run build --if-present
#      - run: npm test

      - name: Archive the build directory
        id: archive
        run: |
          mkdir artifacts
          tar -cvf artifacts/ustp-boss.tar ./build

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ustp-boss
          path: gui/artifacts/
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: [build]
    steps:

      - uses: actions/checkout@main

      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run Bicep deploy
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
          resourceGroupName: ${{ secrets.AZURE_RG }}
          template: ./azure-deploy.bicep
          parameters: 'location=eastus'

      - name: Download artifact from build job
        uses: actions/download-artifact@v3
        with:
          name: ustp-boss

      - name: Unarchive the build
        run: |
          mkdir build
          cd build
          tar -xf ../ustp-boss.tar
          cd ..steps:

      - name: Get WebApp publish profile
        id: webapp
        uses: aliencube/publish-profile-actions@v1
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        with:
          resourceGroupName: '<RESOURCE_GROUP_NAME>'
          appName: '<WEBAPP_NAME>'

      - name: 'Deploy to Azure WebApp'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'ustp-boss-dev'
          publish-profile: ${{ steps.webapp.outputs.profile }}
          package: build/
